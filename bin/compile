#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

MONIT_VERSION="5.8"
MONIT_SOURCE="http://mmonit.com/monit/dist/monit-$MONIT_VERSION.tar.gz"
MONIT_SOURCE_DIR="source/monit"
MONIT_VENDOR="vendor/monit"

GETTEXT_BINARY="http://heroku-monit.s3.amazonaws.com/gettext-0.18.tgz"
GETTEXT_VENDOR="vendor/gettext"

# Vendor Monit
echo "-----> Downloading monit"
echo "$1/$MONIT_SOURCE_DIR"
mkdir -p $1/$MONIT_SOURCE_DIR
curl $MONIT_SOURCE -o - | tar -xz -C $1 -f -

echo "-----> Compiling monit"
cd $1/monit-$MONIT_VERSION
./configure --prefix="$1/$MONIT_VENDOR" --without-pam --without-ssl
make
make install

# Vendor GNU gettext
echo "-----> Downloading gettext"
mkdir -p $1/$GETTEXT_VENDOR
curl $GETTEXT_BINARY -o - | tar -xz -C $1/$GETTEXT_VENDOR -f -

mkdir -p $1/bin

echo "-----> Generating the boot script"
cat >>$1/bin/boot.sh <<'EOF'
#!/usr/bin/env bash

mkdir -p conf.d
mkdir -p tmp/conf

if [ "$SYSTEM_NAME" == "" ]; then
  export SYSTEM_NAME=Heroku
fi

for f in `ls conf.d`
do
  echo "Processing conf.d/$f file..."
  (cat  conf.d/$f | vendor/gettext/bin/envsubst) > tmp/conf/$f.tmp && mv tmp/conf/$f.tmp conf.d/$f
done

(cat monitrc | vendor/gettext/bin/envsubst) > monitrc.tmp && mv monitrc.tmp monitrc

vendor/monit/bin/monit -c monitrc -p tmp/.monit.pid -s tmp/.monit.state -I -v
EOF
chmod +x $1/bin/boot.sh

echo "-----> Done"
