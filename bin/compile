#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

MONIT_BINARY="https://heroku-monit.s3.amazonaws.com/monit-5.4.tgz"
MONIT_VENDOR="vendor/monit"

GETTEXT_BINARY="http://heroku-monit.s3.amazonaws.com/gettext-0.18.tgz"
GETTEXT_VENDOR="vendor/gettext"

# Vendor Monit
echo "-----> Downloading monit"
echo "$1/$MONIT_VENDOR"
mkdir -p $1/$MONIT_VENDOR
curl $MONIT_BINARY -o - | tar -xz -C $1/$MONIT_VENDOR -f -

# Vendor GNU gettext
echo "-----> Downloading gettext"
mkdir -p $1/$GETTEXT_VENDOR
curl $GETTEXT_BINARY -o - | tar -xz -C $1/$GETTEXT_VENDOR -f -

mkdir -p $1/bin

echo "-----> Generating the boot script"
cat >>$1/bin/boot.sh <<'EOF'
#!/usr/bin/env bash

mkdir -p conf.d
mkdir -p tmp/conf

export SYSTEM_NAME=${1:-Heroku}

for f in `ls conf.d`
do
  echo "Processing conf.d/$f file..."
  (cat  conf.d/$f | vendor/gettext/bin/envsubst) > tmp/conf/$f.tmp && mv tmp/conf/$f.tmp conf.d/$f
done

(cat monitrc | vendor/gettext/bin/envsubst) > monitrc.tmp && mv monitrc.tmp monitrc

vendor/monit/bin/monit -c monitrc -p tmp/.monit.pid -s tmp/.monit.state -I
EOF
chmod +x $1/bin/boot.sh

echo "-----> Done"
